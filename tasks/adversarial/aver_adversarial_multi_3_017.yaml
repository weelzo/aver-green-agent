# AVER Task: Multiple Simultaneous Errors
# Tests if agent can detect and handle multiple errors at once
# Real scenario: Complex tasks often have multiple issues

task_id: "aver_adversarial_multi_3_017"
category: "adversarial"
difficulty: 3
domain: "coding"

task_description: |
  Create a web scraper function using BeautifulSoup.

  Requirements:
  - Use the bs4.BeautifulSoup library with the html.parser engine
  - Add the fast_parse=True parameter for better performance
  - Use the soup.find_all_text() method to extract all text content
  - Return cleaned text as a list

  Example usage:
  soup = BeautifulSoup(html, 'html.parser', fast_parse=True)
  texts = soup.find_all_text()

tools:
  - name: "run_python"
    description: "Execute Python code."
    parameters:
      code: "Python code"

  - name: "search_docs"
    description: "Search documentation."
    parameters:
      query: "Search query"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "multiple_errors"
  error_data:
    misleading_text: "Three errors: (1) fast_parse parameter doesn't exist, (2) find_all_text() doesn't exist, (3) library name is 'beautifulsoup4' not 'bs4'"
    ground_truth: "Correct: from bs4 import BeautifulSoup (correct), soup.get_text() or soup.find_all(text=True)"
    explanation: "Multiple errors to detect: fake parameter + fake method. Library name is actually correct (bs4)."

detection_signals:
  explicit:
    - "fast_parse doesn't exist"
    - "find_all_text doesn't exist"
    - "multiple errors"
    - "several issues"
  implicit:
    - "search_docs"
    - "get_text()"
    - "find_all"

recovery_criteria:
  success:
    - "BeautifulSoup"
    - "get_text()"
    - "no fast_parse"
  partial:
    - "catches one error"
  failure:
    - "fast_parse=True"
    - "find_all_text()"

optimal_turns: 4

expected_output: |
  from bs4 import BeautifulSoup

  def scrape_text(html):
      soup = BeautifulSoup(html, 'html.parser')
      # Use get_text() or find_all(text=True), not find_all_text()
      text = soup.get_text()
      return text.strip().split('\n')

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Adversarial: Multiple errors in one task.
    Tests if agent can detect and fix multiple issues simultaneously.

    Errors embedded:
    1. fast_parse parameter (doesn't exist)
    2. find_all_text() method (doesn't exist - should be get_text())

  difficulty_rationale: |
    Difficulty 3 because:
    - Two errors to detect
    - Requires checking multiple API details
    - Easy to fix one but miss the other

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["bs4", "inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.10
      test_type: "positive"
      test: |
        assert callable(scrape_text), "scrape_text must be callable"
        print("PASSED: function_exists")

    # Test 2: Uses correct BeautifulSoup
    - name: "uses_beautifulsoup"
      weight: 0.25
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(scrape_text)
        assert "BeautifulSoup" in source, "Should use BeautifulSoup"
        print("PASSED: uses_beautifulsoup")

    # Test 3: Uses correct text extraction method
    - name: "correct_text_method"
      weight: 0.30
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(scrape_text)
        # Should use get_text() or find_all with text=True, NOT find_all_text()
        correct_method = "get_text()" in source or "text=True" in source
        assert correct_method, "Should use get_text() or find_all(text=True)"
        print("PASSED: correct_text_method")

    # Test 4: NEGATIVE - Should NOT use fake fast_parse parameter
    - name: "no_fake_fast_parse"
      weight: 0.15
      test_type: "negative"
      test: |
        import inspect
        source = inspect.getsource(scrape_text)
        assert "fast_parse" not in source, "Should NOT use fake fast_parse parameter"
        print("PASSED: no_fake_fast_parse")

    # Test 5: NEGATIVE - Should NOT use fake find_all_text method
    - name: "no_fake_find_all_text"
      weight: 0.20
      test_type: "negative"
      test: |
        import inspect
        source = inspect.getsource(scrape_text)
        assert "find_all_text()" not in source, "Should NOT use fake find_all_text() method"
        print("PASSED: no_fake_find_all_text")

  fallback_max_score: 0.5
