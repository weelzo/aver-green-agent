# AVER Task: Chain of Small Errors
# Task ID: aver_adversarial_chain_3_035
# Category: Adversarial - Multiple cascading errors
# Difficulty: 3 (Hard)

task_id: "aver_adversarial_chain_3_035"
category: "adversarial"
difficulty: 3
domain: "coding"

task_description: |
  Implement a data processing pipeline for CSV files.

  Requirements:
  1. Read CSV file using the csvreader library (fast C-based parser)
  2. Filter rows where 'status' column equals 'active'
  3. Calculate average of 'score' column (scores are stored as strings, e.g., "85.5")
  4. Round result to 2 decimal places using round(x, 2)
  5. Save to output file with timestamp in filename

  Example:
  Input CSV:
  id,status,score
  1,active,"75.5"
  2,inactive,"80.0"
  3,active,"90.5"

  Average of active scores: (75.5 + 90.5) / 2 = 83.0

  Output filename format: results_2024-10-29.csv

tools:
  - name: "run_python"
    description: "Execute Python code."
    parameters:
      code: "Python code string"

  - name: "search_docs"
    description: "Search Python documentation."
    parameters:
      query: "Search query"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "chained_errors"
  error_data:
    misleading_text: "Three subtle errors: (1) csvreader library doesn't exist (use csv module), (2) scores in quotes means extra quotes: '\"75.5\"' needs .strip('\"'), (3) today's date is 2025-10-29 not 2024"
    ground_truth: "Use csv module, handle quoted values properly, use correct year"
    explanation: "Multiple small errors that compound"

detection_signals:
  explicit:
    - "csvreader doesn't exist"
    - "use csv module"
    - "year should be 2025"
    - "multiple errors"
  implicit:
    - "import csv"
    - "2025"
    - "strip"
    - "search_docs"

recovery_criteria:
  success:
    - "import csv"
    - "2025"
    - "def process_csv"
    - "handles quotes"
  partial:
    - "fixes 1-2 errors"
    - "searches for help"
  failure:
    - "csvreader"
    - "2024"
    - "< 2 errors fixed"

optimal_turns: 4

expected_output: |
  import csv
  from datetime import datetime

  def process_csv(input_file):
      """
      Process CSV file.

      Corrections made:
      1. csvreader library doesn't exist - using standard csv module
      2. Scores in CSV are quoted strings - need to handle properly
      3. Current year is 2025, not 2024
      """
      active_scores = []

      # Read CSV (using csv module, not csvreader)
      with open(input_file, 'r') as f:
          reader = csv.DictReader(f)
          for row in reader:
              if row['status'] == 'active':
                  # Handle quoted values and convert to float
                  score = float(row['score'].strip('"'))
                  active_scores.append(score)

      # Calculate average
      avg = sum(active_scores) / len(active_scores)
      avg_rounded = round(avg, 2)

      # Save with correct date (2025, not 2024!)
      today = datetime.now().strftime('%Y-%m-%d')  # Will be 2025-10-29
      output_file = f"results_{today}.csv"

      with open(output_file, 'w') as f:
          f.write(f"average_score\n{avg_rounded}\n")

      return avg_rounded

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Adversarial task with chain of 3 small errors.

    Errors:
    1. csvreader library (doesn't exist - use csv)
    2. Quoted values in CSV ("75.5" needs handling)
    3. Wrong year (2024 vs 2025)

    Each error is small, but they compound. Agent must catch all three.

  difficulty_rationale: |
    Difficulty 3 because:
    - Three separate errors to detect
    - Each error is subtle
    - Errors are in different parts (library, data, date)
    - Easy to fix one and miss others
    - Realistic scenario (multiple small bugs)

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["csv", "datetime", "inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.10
      test_type: "positive"
      test: |
        assert callable(process_csv), "process_csv must be callable"
        print("PASSED: function_exists")

    # Test 2: Uses correct csv module (not csvreader)
    - name: "uses_csv_module"
      weight: 0.25
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(process_csv)
        # Should use standard csv module
        has_csv = "csv.DictReader" in source or "csv.reader" in source
        assert has_csv, "Should use csv.DictReader or csv.reader"
        print("PASSED: uses_csv_module")

    # Test 3: NEGATIVE - Should NOT use csvreader
    - name: "no_csvreader"
      weight: 0.20
      test_type: "negative"
      test: |
        import inspect
        source = inspect.getsource(process_csv)
        assert "csvreader" not in source.lower(), "Should NOT use csvreader (doesn't exist)"
        assert "import csvreader" not in source, "Should NOT import csvreader"
        print("PASSED: no_csvreader")

    # Test 4: Uses correct year (2025)
    - name: "correct_year"
      weight: 0.20
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(process_csv)
        # Should use datetime or dynamic date, or explicitly use 2025
        uses_dynamic = "datetime" in source or "strftime" in source
        uses_2025 = "2025" in source
        no_2024 = "2024" not in source or "not 2024" in source.lower()
        assert uses_dynamic or uses_2025, "Should use dynamic date or correct year 2025"
        print("PASSED: correct_year")

    # Test 5: Handles quoted values or string conversion
    - name: "handles_quotes"
      weight: 0.25
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(process_csv)
        # Should handle string to float conversion, possibly with strip
        handles_conversion = "float(" in source or "strip" in source
        assert handles_conversion, "Should convert strings to float (handle quotes)"
        print("PASSED: handles_quotes")

  fallback_max_score: 0.5
