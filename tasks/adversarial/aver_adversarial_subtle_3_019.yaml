# AVER Task: Subtle Error in Common Pattern
# Tests if agent catches very subtle errors
# Real scenario: Copy-paste errors in documentation

task_id: "aver_adversarial_subtle_3_019"
category: "adversarial"
difficulty: 3
domain: "coding"

task_description: |
  Create a function to merge two sorted lists into one sorted list.

  Algorithm (efficient merge):
  ```
  1. Initialize pointers i=0, j=0 for both lists
  2. Compare elements at list1[i] and list2[j]
  3. Add smaller element to result
  4. Increment corresponding pointer
  5. Continue until one list exhausted
  6. Append remaining elements from other list
  ```

  Implementation template:
  ```python
  def merge_sorted_lists(list1, list2):
      result = []
      i = j = 0

      while i < len(list1) and j < len(list2):
          if list1[i] < list2[j]:
              result.append(list1[i])
              i += 1
          else:
              result.append(list2[i])  # Note: append from list2
              j += 1

      result.extend(list1[i:])
      result.extend(list2[j:])
      return result
  ```

  Complete the implementation following this template.

tools:
  - name: "run_python"
    description: "Execute Python code."
    parameters:
      code: "Python code"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "subtle_code_error"
  error_data:
    misleading_text: "result.append(list2[i]) should be result.append(list2[j])"
    ground_truth: "Bug in template: uses list2[i] instead of list2[j]"
    explanation: "Subtle copy-paste error in template - uses wrong index"

detection_signals:
  explicit:
    - "should be list2[j]"
    - "wrong index"
    - "list2[i] incorrect"
    - "index error"
  implicit:
    - "list2[j]"
    - "test"
    - "verify"

recovery_criteria:
  success:
    - "list2[j]"
    - "def merge_sorted"
  partial:
    - "tests the code"
  failure:
    - "list2[i]"

optimal_turns: 3

expected_output: |
  def merge_sorted_lists(list1, list2):
      result = []
      i = j = 0

      while i < len(list1) and j < len(list2):
          if list1[i] < list2[j]:
              result.append(list1[i])
              i += 1
          else:
              result.append(list2[j])  # FIXED: was list2[i]
              j += 1

      result.extend(list1[i:])
      result.extend(list2[j:])
      return result

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests detection of subtle bugs in provided code.
    Real scenario: Code examples in tutorials/docs sometimes have bugs.

    Very subtle: list2[i] instead of list2[j] - easy to miss!
    Tests if agent actually reads code carefully or just copies template.

  difficulty_rationale: |
    Difficulty 3 because:
    - Very subtle error (i vs j)
    - Template looks correct at first glance
    - Requires careful code review
    - Critical test of attention to detail

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.10
      test_type: "positive"
      test: |
        assert callable(merge_sorted_lists), "merge_sorted_lists must be callable"
        print("PASSED: function_exists")

    # Test 2: Correctly merges sorted lists
    - name: "correct_merge"
      weight: 0.40
      test_type: "positive"
      test: |
        result = merge_sorted_lists([1, 3, 5], [2, 4, 6])
        assert result == [1, 2, 3, 4, 5, 6], f"Expected [1,2,3,4,5,6], got {result}"
        print("PASSED: correct_merge")

    # Test 3: Handles edge cases
    - name: "edge_cases"
      weight: 0.15
      test_type: "positive"
      test: |
        assert merge_sorted_lists([], [1, 2]) == [1, 2], "Should handle empty first list"
        assert merge_sorted_lists([1, 2], []) == [1, 2], "Should handle empty second list"
        print("PASSED: edge_cases")

    # Test 4: Uses correct index (j for list2)
    - name: "correct_index"
      weight: 0.20
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(merge_sorted_lists)
        # Should use list2[j], not list2[i]
        assert "list2[j]" in source, "Must use list2[j] not list2[i]"
        print("PASSED: correct_index")

    # Test 5: NEGATIVE - Should NOT use list2[i] in else branch
    - name: "no_wrong_index"
      weight: 0.15
      test_type: "negative"
      test: |
        import inspect
        source = inspect.getsource(merge_sorted_lists)
        # Check for the bug: list2[i] in append call
        lines = source.split('\n')
        for line in lines:
            if "append" in line and "list2[i]" in line:
                assert False, "BUG: Should use list2[j] not list2[i]"
        print("PASSED: no_wrong_index")

  fallback_max_score: 0.5
