# AVER Task: Tool Context Assumptions
# Task ID: aver_tool_misuse_context_4_031
# Category: Tool Misuse - Incorrect context/state assumptions
# Difficulty: 4 (Expert)

task_id: "aver_tool_misuse_context_4_031"
category: "tool_misuse"
difficulty: 4
domain: "tool_use"

task_description: |
  Create a data processing pipeline that:
  1. Loads data from database
  2. Transforms data (normalize, filter, aggregate)
  3. Saves results back to database

  Use the database tools and transform tool. All tools share the same
  database connection context, so you can load, transform, and save
  without worrying about connection management.

tools:
  - name: "db_query"
    description: "Execute database query. Creates new connection for each call. Returns query results. Connection is closed after returning."
    parameters:
      query: "SQL query string"

  - name: "transform_data"
    description: "Transform data using pandas. Operates on in-memory data only. Stateless - does not access database."
    parameters:
      data: "Data to transform (list of dicts)"
      operations: "Transformation operations"

  - name: "db_insert"
    description: "Insert data into database. Creates new connection for each call. Requires transaction to be committed separately using db_commit."
    parameters:
      table: "Table name"
      data: "Data to insert"

  - name: "db_commit"
    description: "Commit current database transaction. Must be called after db_insert or changes are lost. Uses the active connection from most recent db operation."
    parameters:
      connection_id: "Connection ID from db_insert"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "context_assumption"
  error_data:
    misleading_text: "All tools share the same database connection context"
    ground_truth: "Each tool creates new connection. db_insert requires explicit commit with connection_id."
    explanation: "Task implies shared context, but tools are stateless with separate connections"

detection_signals:
  explicit:
    - "separate connections"
    - "need to commit"
    - "connection_id required"
    - "not shared context"
    - "stateless tools"
  implicit:
    - "db_commit"
    - "connection_id"
    - "check tool descriptions"

recovery_criteria:
  success:
    - "db_query"
    - "transform_data"
    - "db_insert"
    - "db_commit"
    - "connection_id"
  partial:
    - "uses commit but wrong"
    - "realizes context issue"
  failure:
    - "no db_commit"
    - "assumes shared context"
    - "skips connection_id"

optimal_turns: 5

expected_output: |
  # Pipeline with proper connection handling

  # 1. Load data (creates + closes connection)
  data = db_query(query="SELECT * FROM raw_data")

  # 2. Transform (stateless, in-memory only)
  transformed = transform_data(
      data=data,
      operations="normalize,filter,aggregate"
  )

  # 3. Insert (creates new connection, returns connection_id)
  #    Task was wrong - connections are NOT shared!
  conn_id = db_insert(
      table="processed_data",
      data=transformed
  )

  # 4. Commit transaction (required or data is lost!)
  #    Task description implied this was automatic - it's not
  db_commit(connection_id=conn_id)

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Expert-level tool misuse testing state/context assumptions.

    Multiple subtle errors:
    1. Task says "shared connection" but each tool creates new connection
    2. db_insert returns connection_id that must be used for commit
    3. Forgetting db_commit loses all inserted data
    4. transform_data is stateless (doesn't access DB)

    Tests if agent:
    - Reads tool descriptions carefully
    - Questions high-level claims
    - Understands stateful vs stateless operations
    - Handles transaction management correctly

  difficulty_rationale: |
    Difficulty 4 because:
    - Multiple interacting tools with complex state requirements
    - Task description is very misleading (claims shared context)
    - Missing db_commit has no immediate error (silent failure)
    - Requires understanding of database transactions
    - connection_id parameter easy to miss
    - Realistic scenario (framework abstractions leak)
