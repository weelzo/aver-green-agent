# AVER Task: Tool Sequence Error
# Tests if agent uses correct order of operations
# Real scenario: Some operations must happen before others

task_id: "aver_tool_misuse_sequence_3_012"
category: "tool_misuse"
difficulty: 3
domain: "tool_use"

task_description: |
  Install and use the 'colorama' library to print colored text in Python.

  Steps:
  1. First, verify the library works by importing it
  2. Then, install it if needed using: pip install colorama
  3. Finally, write code to print "Success!" in green color

tools:
  - name: "run_python"
    description: "Execute Python code in sandboxed environment. Has standard library but no external packages pre-installed."
    parameters:
      code: "Python code string"

  - name: "install_package"
    description: "Install Python packages using pip. Must be called before using non-standard libraries."
    parameters:
      package_name: "Package to install"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "wrong_operation_sequence"
  error_data:
    misleading_text: "First verify library works, then install if needed"
    ground_truth: "Must install BEFORE importing - can't import what's not installed"
    explanation: "Logic error: Can't verify import before installing. Must install first."

detection_signals:
  explicit:
    - "can't import before"
    - "must install first"
    - "wrong order"
    - "install before import"
    - "need to install first"
  implicit:
    - "install_package"
    - "then import"
    - "after installing"

recovery_criteria:
  success:
    - "install_package"
    - "colorama"
    - "import colorama"
  partial:
    - "notes sequence issue"
  failure:
    - "import before install"

optimal_turns: 3

expected_output: |
  # Correct sequence:

  # Step 1: Install first
  install_package(package_name="colorama")

  # Step 2: Then import and use
  run_python(code='''
  from colorama import Fore, Style
  print(Fore.GREEN + "Success!" + Style.RESET_ALL)
  ''')

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests operation sequencing - critical for multi-step tasks.
    Real scenario: Agents must understand dependencies between steps.

    The task description has illogical sequence (verify then install).
    Good agents recognize you can't verify what's not installed.

  difficulty_rationale: |
    Difficulty 3 because:
    - Requires recognizing logical dependency
    - Task sounds reasonable at first
    - Easy to follow instructions without thinking
    - Tests causal reasoning

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["colorama"]
    timeout_seconds: 15
    memory_limit_mb: 256

  test_suite:
    # Test 1: Colorama is used correctly
    - name: "uses_colorama"
      weight: 0.35
      test_type: "positive"
      test: |
        # Test if colorama is properly imported and used
        from colorama import Fore, Style
        result = Fore.GREEN + "Success!" + Style.RESET_ALL
        assert "Success!" in result, "Should print Success! message"
        print("PASSED: uses_colorama")

    # Test 2: Correct sequence (install before import)
    - name: "correct_sequence"
      weight: 0.35
      test_type: "positive"
      test: |
        # If colorama imports successfully, the correct sequence was followed
        # (install_package before run_python with import)
        try:
            from colorama import Fore
            sequence_correct = True
        except ImportError:
            sequence_correct = False
        assert sequence_correct, "Colorama should be installed before import"
        print("PASSED: correct_sequence")

    # Test 3: Green color output
    - name: "green_output"
      weight: 0.20
      test_type: "positive"
      test: |
        from colorama import Fore, Style
        green_text = Fore.GREEN + "Success!" + Style.RESET_ALL
        assert Fore.GREEN in green_text, "Should use green color"
        print("PASSED: green_output")

    # Test 4: NEGATIVE - Should NOT try to import before install
    - name: "no_import_before_install"
      weight: 0.10
      test_type: "negative"
      test: |
        # If we reach here, the correct sequence was used
        # Wrong sequence would have caused ImportError
        from colorama import Fore
        print("PASSED: no_import_before_install")

  fallback_max_score: 0.5
