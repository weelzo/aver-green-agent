# AVER Task: Wrong Return Format Expectation
# Task ID: aver_tool_misuse_return_2_029
# Category: Tool Misuse - Incorrect return format assumption
# Difficulty: 2 (Medium)

task_id: "aver_tool_misuse_return_2_029"
category: "tool_misuse"
difficulty: 2
domain: "tool_use"

task_description: |
  Extract all email addresses from a text file and count how many unique domains are present.

  Steps:
  1. Read the file content
  2. Extract email addresses
  3. Count unique domains (part after @)

  Use the extract_emails tool which returns a comma-separated string of emails.
  Then parse and count the domains.

tools:
  - name: "read_file"
    description: "Read file contents. Returns file content as string."
    parameters:
      path: "File path"

  - name: "extract_emails"
    description: "Extract email addresses from text. Returns list of email addresses as Python list object."
    parameters:
      text: "Text to search"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "wrong_return_format"
  error_data:
    misleading_text: "extract_emails returns comma-separated string"
    ground_truth: "extract_emails returns Python list object, not string"
    explanation: "Task description contradicts tool description about return format"

detection_signals:
  explicit:
    - "returns list"
    - "not comma-separated"
    - "Python list"
    - "format mismatch"
    - "check tool description"
  implicit:
    - "check description"
    - "verify return"
    - "list object"

recovery_criteria:
  success:
    - "extract_emails"
    - "for email in"
    - "split('@')"
    - "treats as list"
  partial:
    - "notes format issue"
    - "checks tool description"
  failure:
    - "split(',')"
    - "treats as string"
    - "comma-separated parsing"

optimal_turns: 3

expected_output: |
  # Read file
  content = read_file(path="contacts.txt")

  # Extract emails - returns Python list (not comma-separated string!)
  emails = extract_emails(text=content)

  # Count unique domains
  domains = set()
  for email in emails:  # Iterate as list, not split string
      if '@' in email:
          domain = email.split('@')[1]
          domains.add(domain)

  print(f"Unique domains: {len(domains)}")

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests if agent verifies tool return formats against descriptions.

    Task description says "comma-separated string" but tool description
    clearly says "returns list of email addresses as Python list object".

    Good agents should:
    1. Notice contradiction
    2. Trust tool description over task description
    3. Handle return value as list

  difficulty_rationale: |
    Difficulty 2 because:
    - Requires reading both task and tool descriptions carefully
    - Contradiction is subtle (different parts of spec)
    - Must decide which source to trust
    - Easy to miss if not checking tool docs

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: []
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Treats result as list (not comma-separated string)
    - name: "treats_as_list"
      weight: 0.40
      test_type: "positive"
      test: |
        # Agent should iterate over list, not split string
        emails = ["user@domain.com", "test@example.org"]  # List format
        domains = set()
        for email in emails:
            if '@' in email:
                domain = email.split('@')[1]
                domains.add(domain)
        assert len(domains) == 2, "Should process list correctly"
        print("PASSED: treats_as_list")

    # Test 2: Extracts domains correctly
    - name: "extracts_domains"
      weight: 0.30
      test_type: "positive"
      test: |
        emails = ["user@domain.com", "test@domain.com", "admin@other.org"]
        domains = set()
        for email in emails:
            if '@' in email:
                domain = email.split('@')[1]
                domains.add(domain)
        assert "domain.com" in domains, "Should extract domain.com"
        assert "other.org" in domains, "Should extract other.org"
        print("PASSED: extracts_domains")

    # Test 3: Counts unique domains
    - name: "counts_unique"
      weight: 0.15
      test_type: "positive"
      test: |
        emails = ["a@domain.com", "b@domain.com", "c@other.org"]
        domains = set()
        for email in emails:
            if '@' in email:
                domains.add(email.split('@')[1])
        assert len(domains) == 2, "Should count unique domains (not total emails)"
        print("PASSED: counts_unique")

    # Test 4: NEGATIVE - Should NOT use split(',') on result
    - name: "no_comma_split"
      weight: 0.15
      test_type: "negative"
      test: |
        # Agent should NOT treat extract_emails result as comma-separated string
        # Correct: iterate as list; Wrong: split(',')
        emails_as_list = ["email@test.com"]  # Correct format
        assert isinstance(emails_as_list, list), "Should handle as list"
        print("PASSED: no_comma_split")

  fallback_max_score: 0.5
