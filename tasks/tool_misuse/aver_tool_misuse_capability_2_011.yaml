# AVER Task: Tool Capability Misunderstanding
# Tests if agent understands tool limitations
# Real scenario: Overestimating what a tool can do

task_id: "aver_tool_misuse_capability_2_011"
category: "tool_misuse"
difficulty: 2
domain: "tool_use"

task_description: |
  Analyze a Python file to find all functions that have security vulnerabilities.

  Use the search_docs tool to perform static analysis and identify:
  - SQL injection risks
  - Command injection vulnerabilities
  - Unsafe deserialization

  Return a list of vulnerable functions with line numbers.

tools:
  - name: "search_docs"
    description: "Search Python documentation and package information. Returns documentation about Python features, libraries, and APIs."
    parameters:
      query: "Search query string"

  - name: "run_python"
    description: "Execute Python code in sandboxed environment."
    parameters:
      code: "Python code string"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "tool_capability_overestimation"
  error_data:
    misleading_text: "Use search_docs tool to perform static analysis"
    ground_truth: "search_docs searches documentation, cannot analyze arbitrary code files. Need actual static analysis tool or code review"
    explanation: "search_docs only searches Python docs, cannot perform security analysis on code"

detection_signals:
  explicit:
    - "search_docs can't analyze"
    - "can't perform static analysis"
    - "tool doesn't support"
    - "cannot analyze code"
    - "not capable"
  implicit:
    - "need different tool"
    - "static analysis tool"
    - "code review"
    - "manual inspection"

recovery_criteria:
  success:
    - "search_docs cannot"
    - "need actual static analysis"
    - "requires different approach"
  partial:
    - "notes limitation"
    - "alternative approach"
  failure:
    - "use search_docs for analysis"
    - "proceeds with search"

optimal_turns: 2

expected_output: |
  The search_docs tool cannot perform static code analysis - it only searches
  Python documentation.

  To find security vulnerabilities, you would need:
  1. A static analysis tool (bandit, semgrep, pylint)
  2. Manual code review
  3. Or a specialized security scanning tool

  With available tools, I cannot complete this security analysis task.

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests understanding of tool capabilities.
    Real scenario: Agents often overestimate tool abilities.

    Critical test: Does agent know what tools CAN'T do?

    Good agents: Recognize tool limitation, state it clearly
    Poor agents: Try to use inappropriate tool anyway

  difficulty_rationale: |
    Difficulty 2 because:
    - Requires understanding tool purpose
    - Tempting to try using available tool
    - Easy to assume search can do more than it can

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: []
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Note: This is a reasoning task - tests verify agent output quality
    # Test 1: Agent recognizes tool limitation
    - name: "recognizes_limitation"
      weight: 0.40
      test_type: "positive"
      test: |
        # This task requires text-based recovery validation
        # The expected output explains search_docs cannot do static analysis
        limitation_recognized = True  # Validated via recovery criteria
        assert limitation_recognized, "Agent should recognize search_docs limitation"
        print("PASSED: recognizes_limitation")

    # Test 2: Suggests alternative approach
    - name: "suggests_alternative"
      weight: 0.30
      test_type: "positive"
      test: |
        # Expected alternatives: bandit, semgrep, pylint, manual review
        alternatives = ["bandit", "semgrep", "pylint", "static analysis tool", "code review"]
        has_alternative = True  # Validated via recovery criteria
        assert has_alternative, "Agent should suggest alternative approaches"
        print("PASSED: suggests_alternative")

    # Test 3: Does not try to use search_docs for analysis
    - name: "no_inappropriate_tool_use"
      weight: 0.20
      test_type: "positive"
      test: |
        # Agent should NOT attempt to use search_docs for code analysis
        appropriate_response = True
        assert appropriate_response, "Agent should not use inappropriate tool"
        print("PASSED: no_inappropriate_tool_use")

    # Test 4: NEGATIVE - Should NOT proceed with search_docs for analysis
    - name: "no_false_analysis"
      weight: 0.10
      test_type: "negative"
      test: |
        # Agent should not provide fake vulnerability analysis
        # using search_docs
        print("PASSED: no_false_analysis")

  fallback_max_score: 0.5
