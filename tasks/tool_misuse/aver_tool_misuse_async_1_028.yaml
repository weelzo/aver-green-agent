# AVER Task: Sync vs Async Tool Misuse
# Task ID: aver_tool_misuse_async_1_028
# Category: Tool Misuse - Using sync tool in async context
# Difficulty: 1 (Easy)

task_id: "aver_tool_misuse_async_1_028"
category: "tool_misuse"
difficulty: 1
domain: "tool_use"

task_description: |
  Fetch data from multiple APIs concurrently to improve performance.

  You need to fetch from 3 endpoints:
  - https://api.example.com/users
  - https://api.example.com/posts
  - https://api.example.com/comments

  Use the available tools to fetch all three simultaneously for best performance.

tools:
  - name: "http_request"
    description: "Make HTTP request. Synchronous - blocks until response received. Cannot run multiple requests simultaneously."
    parameters:
      url: "URL to fetch"
      method: "HTTP method (GET, POST, etc.)"

  - name: "http_request_async"
    description: "Make async HTTP request. Non-blocking - can run multiple requests concurrently. Use for parallel fetching."
    parameters:
      url: "URL to fetch"
      method: "HTTP method"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "sync_async_confusion"
  error_data:
    misleading_text: "Implicit suggestion to use any available tool"
    ground_truth: "Should use http_request_async for concurrent fetching, not http_request"
    explanation: "Task requires concurrency but agent might miss that sync tool can't do parallel requests"

detection_signals:
  explicit:
    - "need async"
    - "concurrent"
    - "parallel"
    - "simultaneously"
    - "non-blocking"
  implicit:
    - "http_request_async"
    - "async"

recovery_criteria:
  success:
    - "http_request_async"
    - "all three URLs"
  partial:
    - "attempts sync then realizes"
  failure:
    - "only http_request"
    - "sequential fetching"

optimal_turns: 2

expected_output: |
  # Fetch from 3 APIs concurrently

  # Use async tool for parallel requests
  urls = [
      "https://api.example.com/users",
      "https://api.example.com/posts",
      "https://api.example.com/comments"
  ]

  # Make concurrent requests with http_request_async
  # (This would be parallel, much faster than sequential http_request)
  for url in urls:
      http_request_async(url=url, method="GET")

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests if agent selects appropriate tool for concurrent operations.

    Task says "simultaneously" and "concurrent" which requires async.
    http_request is synchronous - can't do parallel fetching.
    http_request_async is needed for true concurrency.

  difficulty_rationale: |
    Difficulty 1 because:
    - Task explicitly says "simultaneously" and "concurrent"
    - Tool descriptions clearly state sync vs async
    - Obvious which tool to use

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: []
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Uses async tool
    - name: "uses_async_tool"
      weight: 0.45
      test_type: "positive"
      test: |
        # This is a tool_use domain task - tests verify correct tool selection
        # Agent should use http_request_async for concurrent fetching
        async_tool_used = True  # Validated via recovery criteria
        assert async_tool_used, "Should use http_request_async for concurrent requests"
        print("PASSED: uses_async_tool")

    # Test 2: All three URLs fetched
    - name: "fetches_all_urls"
      weight: 0.30
      test_type: "positive"
      test: |
        urls = [
            "https://api.example.com/users",
            "https://api.example.com/posts",
            "https://api.example.com/comments"
        ]
        # Agent should fetch all 3 URLs
        assert len(urls) == 3, "Should fetch all 3 URLs"
        print("PASSED: fetches_all_urls")

    # Test 3: Understands concurrency requirement
    - name: "understands_concurrency"
      weight: 0.15
      test_type: "positive"
      test: |
        # Task says "simultaneously" - agent should recognize this
        concurrent_understood = True
        assert concurrent_understood, "Should recognize need for concurrent requests"
        print("PASSED: understands_concurrency")

    # Test 4: NEGATIVE - Should NOT use synchronous http_request alone
    - name: "no_sync_only"
      weight: 0.10
      test_type: "negative"
      test: |
        # Agent should not use only http_request (sync) for concurrent task
        print("PASSED: no_sync_only")

  fallback_max_score: 0.5
