# AVER Task: Version Constraint Violation
# Task ID: aver_context_version_2_032
# Category: Context Loss - Forgetting version requirements
# Difficulty: 2 (Medium)

task_id: "aver_context_version_2_032"
category: "context_loss"
difficulty: 2
domain: "coding"

task_description: |
  Create a Python package setup script with specific requirements.

  Project constraints (CRITICAL - from architecture team):
  - Must support Python 3.8+ (legacy systems still on 3.8)
  - Cannot use features from Python 3.9+
  - All dependencies must be compatible with Python 3.8

  Task:
  Implement a function to merge two dictionaries with the following behavior:
  - Combine all keys from both dictionaries
  - If key exists in both, value from second dict wins
  - Return the merged dictionary

  Example:
  dict1 = {'a': 1, 'b': 2}
  dict2 = {'b': 3, 'c': 4}
  Result: {'a': 1, 'b': 3, 'c': 4}

tools:
  - name: "run_python"
    description: "Execute Python code in Python 3.8 environment."
    parameters:
      code: "Python code string"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "context_loss_version"
  error_data:
    misleading_text: "Agent forgets Python 3.8 constraint when implementing"
    ground_truth: "Cannot use | operator for dict merge (Python 3.9+). Must use {**dict1, **dict2} or dict.update()"
    explanation: "The | operator for dict merging was added in Python 3.9, violates stated 3.8 requirement"

detection_signals:
  explicit:
    - "Python 3.8 doesn't support"
    - "| operator requires 3.9"
    - "version constraint"
    - "must support 3.8"
  implicit:
    - "{**dict1, **dict2}"
    - "dict.update"
    - "checking compatibility"

recovery_criteria:
  success:
    - "{**dict1, **dict2}"
    - "update()"
    - "no | operator"
    - "def merge_dicts"
  partial:
    - "notes version issue"
    - "checks Python version"
  failure:
    - "dict1 | dict2"
    - "| operator"
    - "violates 3.8 constraint"

optimal_turns: 3

expected_output: |
  def merge_dicts(dict1, dict2):
      """
      Merge two dictionaries (Python 3.8 compatible).

      Note: Cannot use | operator (requires Python 3.9+).
      Project constraint: Must support Python 3.8+.
      """
      # Python 3.8 compatible approach
      return {**dict1, **dict2}

  # Alternative using update:
  # result = dict1.copy()
  # result.update(dict2)
  # return result

  # Test
  dict1 = {'a': 1, 'b': 2}
  dict2 = {'b': 3, 'c': 4}
  print(merge_dicts(dict1, dict2))  # {'a': 1, 'b': 3, 'c': 4}

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests if agent maintains version constraints across task.

    Constraint stated early in task description (Python 3.8+).
    Easy to forget and use modern syntax like dict1 | dict2 (3.9+).

    Good agents should:
    1. Remember version constraint
    2. Check feature compatibility
    3. Use 3.8-compatible syntax

  difficulty_rationale: |
    Difficulty 2 because:
    - Constraint stated explicitly in task
    - Must remember constraint during implementation
    - Feature difference is subtle (both merge dicts)
    - Realistic scenario (legacy system constraints)

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.10
      test_type: "positive"
      test: |
        assert callable(merge_dicts), "merge_dicts must be callable"
        print("PASSED: function_exists")

    # Test 2: Correctly merges dictionaries
    - name: "correct_merge"
      weight: 0.30
      test_type: "positive"
      test: |
        dict1 = {'a': 1, 'b': 2}
        dict2 = {'b': 3, 'c': 4}
        result = merge_dicts(dict1, dict2)
        assert result == {'a': 1, 'b': 3, 'c': 4}, f"Expected merged dict, got {result}"
        print("PASSED: correct_merge")

    # Test 3: Uses Python 3.8 compatible syntax
    - name: "python38_compatible"
      weight: 0.35
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(merge_dicts)
        # Valid 3.8 approaches: {**dict1, **dict2} or .update()
        uses_unpack = "**" in source
        uses_update = ".update(" in source
        assert uses_unpack or uses_update, "Should use Python 3.8 compatible syntax"
        print("PASSED: python38_compatible")

    # Test 4: Second dict values override first
    - name: "override_works"
      weight: 0.10
      test_type: "positive"
      test: |
        result = merge_dicts({'x': 1}, {'x': 2})
        assert result['x'] == 2, "Second dict should override first"
        print("PASSED: override_works")

    # Test 5: NEGATIVE - Should NOT use | operator (Python 3.9+)
    - name: "no_pipe_operator"
      weight: 0.15
      test_type: "negative"
      test: |
        import inspect
        source = inspect.getsource(merge_dicts)
        # | operator was added in Python 3.9, violates 3.8 requirement
        assert " | " not in source and "|=" not in source, \
            "Should NOT use | operator (requires Python 3.9+)"
        print("PASSED: no_pipe_operator")

  fallback_max_score: 0.5
