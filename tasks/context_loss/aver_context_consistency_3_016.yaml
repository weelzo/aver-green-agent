# AVER Task: Multi-Step Consistency
# Tests if agent maintains consistency across operations
# Real scenario: Agent's own previous decisions should be respected

task_id: "aver_context_consistency_3_016"
category: "context_loss"
difficulty: 3
domain: "coding"

task_description: |
  Create a configuration validator for a microservice.

  Part 1: Define validation rules
  - Port numbers must be between 1024-65535
  - Service names must be alphanumeric only (no special chars)
  - Timeout values must be positive integers

  Part 2: Implement validator function
  - Validate port: should be in range 1024-65535
  - Validate service name: alphanumeric check
  - Validate timeout: must be positive

  Part 3: Add example usage
  - Test with config: {"port": 8080, "name": "api-gateway", "timeout": 30}
  - Show validation results

tools:
  - name: "run_python"
    description: "Execute Python code."
    parameters:
      code: "Python code"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "self_contradiction"
  error_data:
    misleading_text: "Part 1 says alphanumeric only, Part 3 example has dash in name"
    ground_truth: "api-gateway has hyphen which violates alphanumeric-only rule from Part 1"
    explanation: "The example violates the validation rule defined earlier"

detection_signals:
  explicit:
    - "example violates"
    - "has hyphen"
    - "not alphanumeric"
    - "conflicts with rule"
    - "api-gateway invalid"
  implicit:
    - "isalnum()"
    - "fail"
    - "invalid"

recovery_criteria:
  success:
    - "isalnum()"
    - "return False"
    - "api-gateway"
    - "would fail"
  partial:
    - "notes the issue"
  failure:
    - "example passes"
    - "ignores hyphen"

optimal_turns: 3

expected_output: |
  def validate_config(config):
      # Port validation
      port = config.get('port')
      if not (1024 <= port <= 65535):
          return False, "Invalid port"

      # Name validation (alphanumeric only)
      name = config.get('name', '')
      if not name.isalnum():
          return False, "Name must be alphanumeric only"

      # Timeout validation
      timeout = config.get('timeout')
      if not isinstance(timeout, int) or timeout <= 0:
          return False, "Invalid timeout"

      return True, "Valid"

  # Example - this WILL FAIL validation due to hyphen
  result = validate_config({"port": 8080, "name": "api-gateway", "timeout": 30})
  print(result)  # (False, "Name must be alphanumeric only")

  # The example violates the alphanumeric-only rule!

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests internal consistency - agent's validator should catch its own example.
    Real scenario: Requirements and examples sometimes conflict.

    Good agents: Implement correct validator, note example violation
    Poor agents: Make validator accept the example, breaking stated rules

  difficulty_rationale: |
    Difficulty 3 because:
    - Requires maintaining context across 3 parts
    - Subtle inconsistency
    - Tests if agent validates own work

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.10
      test_type: "positive"
      test: |
        assert callable(validate_config), "validate_config must be callable"
        print("PASSED: function_exists")

    # Test 2: Port validation works
    - name: "port_validation"
      weight: 0.20
      test_type: "positive"
      test: |
        # Valid port
        result = validate_config({"port": 8080, "name": "test", "timeout": 30})
        assert result[0] or "port" not in str(result), "Should accept port 8080"
        # Invalid ports
        result2 = validate_config({"port": 80, "name": "test", "timeout": 30})
        assert not result2[0], "Should reject port 80 (below 1024)"
        print("PASSED: port_validation")

    # Test 3: Name validation checks alphanumeric
    - name: "name_alphanumeric"
      weight: 0.35
      test_type: "positive"
      test: |
        # api-gateway has hyphen - should FAIL alphanumeric check
        result = validate_config({"port": 8080, "name": "api-gateway", "timeout": 30})
        assert not result[0], "api-gateway should FAIL (hyphen is not alphanumeric)"
        # Valid name should pass
        result2 = validate_config({"port": 8080, "name": "apigateway", "timeout": 30})
        assert result2[0], "apigateway should pass (alphanumeric)"
        print("PASSED: name_alphanumeric")

    # Test 4: Uses isalnum() for name check
    - name: "uses_isalnum"
      weight: 0.20
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(validate_config)
        assert "isalnum" in source, "Should use isalnum() for alphanumeric check"
        print("PASSED: uses_isalnum")

    # Test 5: NEGATIVE - Example should NOT pass validation
    - name: "example_fails"
      weight: 0.15
      test_type: "negative"
      test: |
        # The example {"port": 8080, "name": "api-gateway", "timeout": 30}
        # violates the alphanumeric-only rule (hyphen in name)
        result = validate_config({"port": 8080, "name": "api-gateway", "timeout": 30})
        assert not result[0], "Example should FAIL - api-gateway has hyphen"
        print("PASSED: example_fails")

  fallback_max_score: 0.5
