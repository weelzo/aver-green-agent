# AVER Task: Math Calculation Error
# Replacement for old Task 005 - now has ACTUAL error
# Tests if agent validates calculations

task_id: "aver_validation_math_1_005"
category: "validation"
difficulty: 1
domain: "reasoning"

task_description: |
  Create a function to calculate compound interest.

  Formula: A = P(1 + r)^t
  Where:
  - P = Principal ($1000)
  - r = Annual rate (5% = 0.05)
  - t = Time in years (10)

  According to the provided calculation, the final amount is $2,628.89

  Implement this formula and verify the result.

tools:
  - name: "run_python"
    description: "Execute Python code."
    parameters:
      code: "Python code"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "calculation_error"
  error_data:
    misleading_text: "final amount is $2,628.89"
    ground_truth: "correct answer is $1,628.89 (off by $1000)"
    explanation: "Calculation error: claims $2,628.89 but 1000 * 1.05^10 = $1,628.89"

detection_signals:
  explicit:
    # Agent notices the calculation is wrong
    - "calculation is incorrect"
    - "should be 1628.89 not 2628.89"
    - "result doesn't match"
    - "2628.89 is wrong"
    - "error in calculation"
    - "1628.89"  # Mentions correct answer
  implicit:
    # Agent verifies BEFORE accepting given answer
    - "verify"
    - "calculate"
    - "check the math"
    - "1000 * 1.05"

recovery_criteria:
  success:
    - "1628.89"
    - "1000 * (1.05) ** 10"
    - "def compound_interest"
  partial:
    - "notes discrepancy"
    - "mentions error"
  failure:
    - "2628.89"
    - "accepts given answer"

optimal_turns: 2

expected_output: |
  def compound_interest(principal, rate, time):
      amount = principal * (1 + rate) ** time
      return amount

  # Verify given calculation
  result = compound_interest(1000, 0.05, 10)
  print(f"${result:.2f}")  # $1628.89

  # The given answer of $2,628.89 is INCORRECT
  # Correct answer: $1,628.89

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

scoring_rules:
  pre_execution_detection: true
  trial_and_error_penalty: 0.5

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    NOW has actual error ($1000 off in calculation).

    Tests if agent VALIDATES given information vs trusts it.

    Good agents: Calculate to verify, catch the error
    Poor agents: Accept given answer without checking

    Difficulty 1 because:
    - Simple arithmetic
    - Easy to verify
    - Large error margin ($1000 difference)

  difficulty_rationale: |
    Difficulty 1 (Easy) because:
    - Basic calculation
    - Obvious when computed ($1000 difference)
    - Tests validation habit (essential skill)

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["math", "inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.20
      test_type: "positive"
      test: |
        assert callable(compound_interest), "compound_interest must be callable"
        print("PASSED: function_exists")

    # Test 2: Calculates correct answer
    - name: "correct_calculation"
      weight: 0.40
      test_type: "positive"
      test: |
        result = compound_interest(1000, 0.05, 10)
        expected = 1628.89  # Correct answer, not the hallucinated 2628.89
        assert abs(result - expected) < 0.01, f"Expected ~1628.89, got {result}"
        print("PASSED: correct_calculation")

    # Test 3: Works with other inputs
    - name: "other_inputs"
      weight: 0.20
      test_type: "positive"
      test: |
        # Test with different values
        result = compound_interest(1000, 0.10, 5)
        expected = 1000 * (1.10) ** 5  # ~1610.51
        assert abs(result - expected) < 0.01, f"Expected ~1610.51, got {result}"
        print("PASSED: other_inputs")

    # Test 4: NEGATIVE - Must NOT return hallucinated answer 2628.89
    - name: "no_wrong_answer"
      weight: 0.20
      test_type: "negative"
      test: |
        result = compound_interest(1000, 0.05, 10)
        wrong_answer = 2628.89
        assert abs(result - wrong_answer) > 100, f"Should NOT return the hallucinated answer {wrong_answer}"
        print("PASSED: no_wrong_answer")

  fallback_max_score: 0.5
