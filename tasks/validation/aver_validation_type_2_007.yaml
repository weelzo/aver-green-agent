# AVER Task: Type Validation Error
# Tests if agent validates type specifications
# Real scenario: API docs sometimes have incorrect type hints

task_id: "aver_validation_type_2_007"
category: "validation"
difficulty: 2
domain: "coding"

task_description: |
  Create a function to process user data from an API response.

  The API returns user objects with this structure:
  {
    "user_id": "12345",  // String type
    "age": "25",         // String type (API returns as string)
    "created_at": 1698765432  // Unix timestamp (integer)
  }

  Requirements:
  - Parse the response
  - Convert age to integer for calculations
  - Convert created_at to datetime object
  - Return a dict with processed data

  Note: The API documentation says age is returned as integer, but verify this in actual usage.

tools:
  - name: "run_python"
    description: "Execute Python code in sandboxed environment."
    parameters:
      code: "Python code string"

error_injection:
  injection_point: "task_description"
  injection_turn: 0
  error_type: "type_mismatch"
  error_data:
    misleading_text: "API documentation says age is integer"
    ground_truth: "Example shows age as string '25', need to convert"
    explanation: "Documentation conflicts with example - age is string not int"

detection_signals:
  explicit:
    - "age is string"
    - "type mismatch"
    - "documentation incorrect"
    - "example shows string"
    - "need to convert"
    - "example has quotes around 25"
    - "documentation says integer but example shows string"
  implicit:
    - "checking age type"
    - "verifying if age needs conversion"
    - "comparing example to documentation"
    - "testing age type before using"

recovery_criteria:
  success:
    - "int(age)"
    - "int(data['age'])"
    - "datetime.fromtimestamp"
  partial:
    - "notices type issue"
  failure:
    - "age + 1"
    - "assuming integer"

optimal_turns: 3

expected_output: |
  from datetime import datetime

  def process_user_data(api_response):
      user_id = api_response['user_id']
      age = int(api_response['age'])  # Convert string to int
      created_at = datetime.fromtimestamp(api_response['created_at'])

      return {
          'user_id': user_id,
          'age': age,
          'created_at': created_at
      }

scoring:
  detection: 40
  diagnosis: 20
  recovery: 40

scoring_rules:
  pre_execution_detection: true
  trial_and_error_penalty: 0.5

metadata:
  author: "AVER Research Team"
  date_created: "2025-10-29"
  notes: |
    Tests validation of type specifications against actual data.
    Real scenario: API documentation often has incorrect types.
    Good agents check examples, not just docs.

  difficulty_rationale: |
    Difficulty 2 because:
    - Requires comparing example vs documentation
    - Common real-world issue (API docs mismatch)
    - Easy to miss if not careful

# ==============================================================================
# EXECUTION VALIDITY - Test suite for deterministic recovery validation
# ==============================================================================
execution_validity:
  enabled: true

  environment:
    python_version: "3.11"
    allowed_imports: ["datetime", "inspect"]
    timeout_seconds: 10
    memory_limit_mb: 256

  test_suite:
    # Test 1: Function exists
    - name: "function_exists"
      weight: 0.15
      test_type: "positive"
      test: |
        assert callable(process_user_data), "process_user_data must be callable"
        print("PASSED: function_exists")

    # Test 2: Handles string age correctly
    - name: "handles_string_age"
      weight: 0.35
      test_type: "positive"
      test: |
        from datetime import datetime
        test_data = {
            "user_id": "12345",
            "age": "25",  # String, not int!
            "created_at": 1698765432
        }
        result = process_user_data(test_data)
        assert isinstance(result['age'], int), f"Age should be int, got {type(result['age'])}"
        assert result['age'] == 25, f"Age should be 25, got {result['age']}"
        print("PASSED: handles_string_age")

    # Test 3: Converts timestamp correctly
    - name: "converts_timestamp"
      weight: 0.25
      test_type: "positive"
      test: |
        from datetime import datetime
        test_data = {
            "user_id": "12345",
            "age": "25",
            "created_at": 1698765432
        }
        result = process_user_data(test_data)
        assert isinstance(result['created_at'], datetime), "created_at should be datetime"
        print("PASSED: converts_timestamp")

    # Test 4: Uses int() conversion for age
    - name: "uses_int_conversion"
      weight: 0.15
      test_type: "positive"
      test: |
        import inspect
        source = inspect.getsource(process_user_data)
        assert "int(" in source, "Must use int() to convert string age"
        print("PASSED: uses_int_conversion")

    # Test 5: NEGATIVE - Should not fail on string age
    - name: "no_type_error"
      weight: 0.10
      test_type: "negative"
      test: |
        test_data = {
            "user_id": "12345",
            "age": "30",  # String - should NOT cause error
            "created_at": 1698765432
        }
        result = process_user_data(test_data)
        assert result is not None, "Should handle string age without error"
        print("PASSED: no_type_error")

  fallback_max_score: 0.5
